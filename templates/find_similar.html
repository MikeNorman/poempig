<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Vibe - Poem Pig</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script>
        console.log('Page loaded at:', new Date().toISOString());
        console.log('JavaScript is working!');
        console.log('Script version:', 'v2.0');
    </script>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <div class="nav-content">
                <a href="/" class="nav-btn">New Vibe</a>
                <a href="/vibes" class="nav-btn">Vibe List</a>
            </div>
        </nav>
        
        <div class="header">
            <h1>
                <span class="pig-icon">üê∑</span>
                Vibe Match
            </h1>
            <p>Create a vibe and root out matching poems</p>
        </div>
        
        <button class="back-btn" onclick="goBack()">‚Üê Back to Search</button>
        
        <div class="main-content">
            <div class="vibe-seeds-container">
                <input type="text" id="vibe-profile-name" class="vibe-profile-name" placeholder="Vibe Profile Name" value="Vibe Seed">
                <div id="vibe-seeds-content">
                    <div class="loading">üê∑ Loading chosen poem...</div>
                </div>
            </div>
            
            <div class="suggested-poems-container">
                <!-- Keyword Search Trigger -->
                <div class="keyword-search-trigger" style="margin-bottom: 20px;">
                    <div class="keyword-search-form">
                        <input type="text" id="keyword-search-input" class="keyword-search-input" placeholder="Search for keywords in title, author, or text...">
                        <button class="keyword-search-btn" onclick="performKeywordSearch()">üîç Search Keywords</button>
                    </div>
                </div>
                
                <!-- Keyword Search Results Section -->
                <div id="keyword-search-container" class="keyword-search-container" style="display: none;">
                    <div class="keyword-search-header">
                        <h3 class="keyword-search-title">Keyword Search Results</h3>
                        <button class="clear-keyword-search" onclick="clearKeywordSearch()">‚úï Clear</button>
                    </div>
                    <div id="keyword-search-results" class="keyword-search-results">
                        <!-- Keyword search results will be displayed here -->
                    </div>
                </div>
                
                <h2 class="suggested-poems-title">Suggested Poems</h2>
                <div id="suggested-poems-content">
                    <div class="loading">Loading similar poems...</div>
                </div>
                <div class="find-more-container">
                    <button id="find-more-btn" class="find-more-btn" onclick="findMorePoems()">
                        Find 5 More Poems
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Test function
        function testFunction() {
            alert('JavaScript is working!');
            console.log('Test function called');
        }
        
        // Debug function
        function debugInfo() {
            console.log('=== DEBUG INFO ===');
            console.log('poemId:', poemId);
            console.log('vibeProfileId:', vibeProfileId);
            console.log('currentVibeProfileId:', currentVibeProfileId);
            console.log('vibeProfilePoems.size:', vibeProfilePoems.size);
            console.log('vibeProfilePoems:', Array.from(vibeProfilePoems));
            console.log('==================');
        }
        
        const API_BASE_URL = 'http://localhost:5001';
        let vibeProfilePoems = new Set();
        let currentVibeProfileId = null;
        let currentVibeProfileName = 'Vibe Seed';
        let displayedPoemIds = new Set(); // Track poems currently displayed in suggested poems
        
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const poemId = urlParams.get('id');
        const vibeProfileId = urlParams.get('vibe_profile_id');
        
        if (vibeProfileId) {
            // Load existing vibe profile
            loadVibeProfile(vibeProfileId);
            setupVibeProfileNameEditor();
        } else if (poemId) {
            // Load poem and find similar
            console.log('Loading poem and finding similar for poemId:', poemId);
            loadChosenPoem();
            loadSimilarPoems(); // This will load in background
            setupVibeProfileNameEditor();
        } else {
            document.getElementById('vibe-seeds-content').innerHTML = 
                '<div class="error">‚ùå No item ID or vibe profile ID provided</div>';
            document.getElementById('suggested-poems-content').innerHTML = 
                '<div class="error">‚ùå Cannot find similar items</div>';
        }
        
        function generateVibeProfileName() {
            const adjectives = ['Mystical', 'Whimsical', 'Melancholic', 'Ethereal', 'Vibrant', 'Serene', 'Passionate', 'Dreamy', 'Bold', 'Gentle', 'Wild', 'Tranquil', 'Fiery', 'Soft', 'Radiant', 'Deep', 'Bright', 'Dark', 'Warm', 'Cool'];
            const nouns = ['Whispers', 'Echoes', 'Dreams', 'Winds', 'Flames', 'Waves', 'Stars', 'Moon', 'Sun', 'Clouds', 'Rivers', 'Mountains', 'Forests', 'Gardens', 'Meadows', 'Oceans', 'Skies', 'Hearts', 'Souls', 'Spirits'];
            
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            return `${adj} ${noun}`;
        }
        
        function setupVibeProfileNameEditor() {
            const nameInput = document.getElementById('vibe-profile-name');
            
            nameInput.addEventListener('blur', async function() {
                const newName = this.value.trim() || generateVibeProfileName();
                this.value = newName;
                currentVibeProfileName = newName;
                
                if (currentVibeProfileId) {
                    await updateVibeProfileName(newName);
                }
            });
            
            nameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                }
            });
        }
        
        async function updateVibeProfileName(name) {
            if (!currentVibeProfileId) return;
            
            try {
                const response = await fetch('/update-vibe-profile-name', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        vibe_profile_id: currentVibeProfileId, 
                        name: name 
                    })
                });
                
                if (!response.ok) {
                    console.error('Failed to update vibe profile name');
                }
            } catch (error) {
                console.error('Error updating vibe profile name:', error);
            }
        }
        
        async function loadVibeProfile(vibeProfileId) {
            try {
                // Get the vibe profile details
                const response = await fetch(`/get-vibe-profile/${vibeProfileId}`);
                if (!response.ok) {
                    throw new Error('Vibe profile not found');
                }
                
                const vibeProfile = await response.json();
                console.log('Loaded vibe profile:', vibeProfile);
                currentVibeProfileId = vibeProfile.id;
                currentVibeProfileName = vibeProfile.name;
                console.log('Set currentVibeProfileId to:', currentVibeProfileId);
                
                // Ensure URL reflects the vibe profile ID
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('id'); // Remove poem ID if present
                newUrl.searchParams.set('vibe_profile_id', currentVibeProfileId);
                window.history.replaceState({}, '', newUrl);
                
                // Set the vibe profile name in the input
                document.getElementById('vibe-profile-name').value = vibeProfile.name;
                
                // Load the poems from this vibe profile
                const poems = vibeProfile.poems || [];
                vibeProfilePoems.clear();
                
                poems.forEach(poem => {
                    vibeProfilePoems.add(poem.id);
                });
                
                // Display the vibe seeds immediately
                await displayVibeSeeds();
                
                // Load similar poems in the background (don't await)
                loadSimilarToVibeProfile();
                
            } catch (error) {
                console.error('Error loading vibe profile:', error);
                document.getElementById('vibe-seeds-content').innerHTML = 
                    '<div class="error">‚ùå Error loading vibe profile</div>';
                document.getElementById('suggested-poems-content').innerHTML = 
                    '<div class="error">‚ùå Cannot load similar poems</div>';
            }
        }
        
        async function loadSimilarToVibeProfile() {
            try {
                const response = await fetch('/find-similar-to-vibe-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        vibe_profile_id: currentVibeProfileId,
                        top_k: 5
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to find similar poems');
                }
                
                const data = await response.json();
                displaySuggestedPoems(data.results || []);
                
            } catch (error) {
                console.error('Error finding similar poems:', error);
                document.getElementById('suggested-poems-content').innerHTML = 
                    '<div class="error">‚ùå Error finding similar poems</div>';
            }
        }
        
        async function loadChosenPoem() {
            try {
                const response = await fetch(`/item/${poemId}`);
                if (!response.ok) {
                    throw new Error('Item not found');
                }
                
                const poem = await response.json();
                vibeProfilePoems.add(poem.id);
                displayVibeSeeds();
            } catch (error) {
                document.getElementById('vibe-seeds-content').innerHTML = 
                    `<div class="error">‚ùå Error loading item: ${error.message}</div>`;
            }
        }
        
        async function loadSimilarPoems() {
            console.log('loadSimilarPoems called with poemId:', poemId);
            try {
                const response = await fetch('/find-similar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ item_id: poemId, top_k: 5 })
                });
                
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('API error:', error);
                    throw new Error(error.error || 'Failed to find similar poems');
                }
                
                const result = await response.json();
                console.log('API result:', result);
                displaySuggestedPoems(result.results);
            } catch (error) {
                console.error('Error in loadSimilarPoems:', error);
                document.getElementById('suggested-poems-content').innerHTML = 
                    `<div class="error">‚ùå Error finding similar items: ${error.message}</div>`;
            }
        }
        
        async function displayVibeSeeds() {
            const nameInput = document.getElementById('vibe-profile-name');
            const content = document.getElementById('vibe-seeds-content');
            
            
            if (vibeProfilePoems.size === 0) {
                content.innerHTML = '<div class="loading">üê∑ Loading chosen poem...</div>';
                return;
            }
            
            // Update placeholder based on count
            nameInput.placeholder = vibeProfilePoems.size === 1 ? 'Vibe Seed' : 'Vibe Seeds';
            
            // Load all poems in vibe profile
            const poems = [];
            for (const poemId of vibeProfilePoems) {
                try {
                    const response = await fetch(`/item/${poemId}`);
                    if (response.ok) {
                        const poem = await response.json();
                        poems.push(poem);
                    }
                } catch (error) {
                    console.error(`Error loading poem ${poemId}:`, error);
                }
            }
            
            let html = '';
            poems.forEach(poem => {
                html += `
                    <div class="poem-card chosen-poem-card">
                        <div class="poem-title">${poem.title || 'Untitled'}</div>
                        <div class="poem-author">by ${poem.author || 'Unknown'}</div>
                        <div class="poem-text">${poem.text}</div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }
        
        function displaySuggestedPoems(poems, append = false) {
            console.log('displaySuggestedPoems called with:', poems, 'append:', append);
            if (!poems || poems.length === 0) {
                if (!append) {
                    document.getElementById('suggested-poems-content').innerHTML = 
                        '<div class="error">No similar poems found</div>';
                }
                return;
            }
            
            // Clear displayed poems only if not appending
            if (!append) {
                displayedPoemIds.clear();
            }
            
            let html = '';
            poems.forEach((result) => {
                // The API returns {item: {...}, similarity: ...}
                const poem = result.item;
                if (!poem) return;
                
                // Track this poem as displayed
                displayedPoemIds.add(poem.id);
                
                const isInVibeProfile = vibeProfilePoems.has(poem.id);
                
                html += `
                    <div class="poem-card">
                        <div class="poem-title">${poem.title || 'Untitled'}</div>
                        <div class="poem-author">by ${poem.author || 'Unknown'}</div>
                        <div class="poem-text">${poem.text}</div>
                        <div class="poem-meta">
                            <div class="poem-buttons">
                                <button class="same-vibe-btn ${isInVibeProfile ? 'added' : ''}"
                                        onclick="addToCurrentVibe('${poem.id}', this)">
                                    ${isInVibeProfile ? 'Added' : 'Add'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const contentElement = document.getElementById('suggested-poems-content');
            if (append) {
                contentElement.innerHTML += html;
            } else {
                contentElement.innerHTML = html;
            }
        }
        
        
        async function addToCurrentVibe(poemId, button) {
            
            if (vibeProfilePoems.has(poemId)) {
                // Already in vibe profile, remove it
                vibeProfilePoems.delete(poemId);
                button.textContent = 'Add';
                button.classList.remove('added');
            } else {
                // Add to vibe profile
                vibeProfilePoems.add(poemId);
                button.textContent = 'Added';
                button.classList.add('added');
                
                // Remove the poem from suggested poems display
                removePoemFromSuggested(poemId);
            }
            
            // Update the vibe profile in the database
            await updateVibeProfileInDatabase();
            
            // Refresh the vibe seeds display
            await displayVibeSeeds();
        }
        
        
        function removePoemFromSuggested(poemId) {
            // Find and remove the poem card from suggested poems
            const suggestedContainer = document.getElementById('suggested-poems-content');
            const poemCards = suggestedContainer.querySelectorAll('.poem-card');
            
            poemCards.forEach(card => {
                const buttons = card.querySelectorAll('button');
                buttons.forEach(button => {
                    if (button.onclick && button.onclick.toString().includes(poemId)) {
                        // This is the card with the poem we want to remove
                        card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            card.remove();
                        }, 300);
                    }
                });
            });
        }
        
        async function updateVibeProfileInDatabase() {
            console.log('updateVibeProfileInDatabase called, currentVibeProfileId:', currentVibeProfileId);
            console.log('Poems to add:', Array.from(vibeProfilePoems));
            
            // Only create a vibe profile if we have 2 or more poems
            if (!currentVibeProfileId && vibeProfilePoems.size >= 2) {
                // Generate a name for the vibe profile
                const generatedName = generateVibeProfileName();
                currentVibeProfileName = generatedName;
                document.getElementById('vibe-profile-name').value = generatedName;
                
                console.log('Creating new vibe profile with name:', generatedName);
                
                // Create a new vibe profile
                try {
                    const response = await fetch('/create-vibe-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            name: generatedName,
                            item_ids: Array.from(vibeProfilePoems)
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        currentVibeProfileId = result.vibe_profile_id;
                        console.log('Created vibe profile with ID:', currentVibeProfileId);
                        
                        // Update the URL to reflect the vibe profile ID
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.delete('id'); // Remove poem ID
                        newUrl.searchParams.set('vibe_profile_id', currentVibeProfileId);
                        window.history.replaceState({}, '', newUrl);
                    } else {
                        console.error('Failed to create vibe profile:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Error creating vibe profile:', error);
                }
            } else if (!currentVibeProfileId && vibeProfilePoems.size < 2) {
                console.log('Not creating vibe profile yet - need at least 2 poems (currently have', vibeProfilePoems.size, ')');
                return; // Exit early if we don't have enough poems
            }
            
            if (currentVibeProfileId) {
                console.log('Adding poems to vibe profile:', currentVibeProfileId);
                // Add all poems to the vibe profile
                for (const poemId of vibeProfilePoems) {
                    try {
                        console.log('Adding poem to vibe profile:', poemId);
                        const response = await fetch('/add-to-vibe-profile', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                item_id: poemId, 
                                vibe_profile_id: currentVibeProfileId 
                            })
                        });
                        
                        if (response.ok) {
                            console.log('Successfully added poem to vibe profile');
                        } else {
                            console.error('Failed to add poem to vibe profile:', response.status, response.statusText);
                        }
                    } catch (error) {
                        console.error(`Error adding poem ${poemId} to vibe profile:`, error);
                    }
                }
            } else {
                console.error('No vibe profile ID available');
            }
        }
        
        async function findMorePoems() {
            console.log('findMorePoems called');
            const button = document.getElementById('find-more-btn');
            button.disabled = true;
            button.textContent = 'Loading...';
            
            try {
                let response;
                console.log('vibeProfilePoems.size:', vibeProfilePoems.size);
                console.log('currentVibeProfileId:', currentVibeProfileId);
                
                if (vibeProfilePoems.size > 1) {
                    // Multiple poems - vibe profile MUST exist (created when 2nd poem added)
                    if (!currentVibeProfileId) {
                        throw new Error('Vibe profile should exist for multiple poems');
                    }
                    
                    console.log('Using vibe profile API');
                    // Use existing vibe profile
                    response = await fetch('/find-similar-to-vibe-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            vibe_profile_id: currentVibeProfileId, 
                            top_k: 5,
                            exclude_item_ids: Array.from(displayedPoemIds)
                        })
                    });
                } else {
                    console.log('Using single poem API');
                    // Single poem - use that poem's vector
                    response = await fetch('/find-similar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            item_id: poemId, 
                            top_k: 5,
                            exclude_item_ids: Array.from(new Set([...vibeProfilePoems, ...displayedPoemIds]))
                        })
                    });
                }
                
                console.log('Response status:', response.status);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to find more poems');
                }
                
                const result = await response.json();
                console.log('API result:', result);
                console.log('Calling displaySuggestedPoems with append=true:', result.results);
                displaySuggestedPoems(result.results || [], true);
            } catch (error) {
                console.error('Error in findMorePoems:', error);
                document.getElementById('suggested-poems-content').innerHTML = 
                    `<div class="error">‚ùå Error finding more poems: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'Find 5 More Poems';
            }
        }
        
        function goBack() {
            window.history.back();
        }
        
        // Keyword search functionality
        async function performKeywordSearch() {
            const input = document.getElementById('keyword-search-input');
            const keywords = input.value.trim();
            
            if (!keywords) {
                alert('Please enter keywords to search for');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/search-keywords`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords })
                });
                
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                displayKeywordResults(data.results);
                
                // Show the keyword search container
                document.getElementById('keyword-search-container').style.display = 'block';
                
            } catch (error) {
                console.error('Keyword search error:', error);
                showError('Failed to search keywords: ' + error.message);
            }
        }
        
        function displayKeywordResults(results) {
            const container = document.getElementById('keyword-search-results');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="no-keyword-results">No items found matching your keywords</div>';
                return;
            }
            
            container.innerHTML = '';
            results.forEach(result => {
                const item = result.item;
                const card = document.createElement('div');
                card.className = 'keyword-poem-card';
                
                card.innerHTML = `
                    <div class="keyword-poem-title">${item.title || 'Untitled'}</div>
                    <div class="keyword-poem-author">by ${item.author || 'Unknown'}</div>
                    <div class="keyword-poem-text">${item.text}</div>
                    <div class="keyword-poem-buttons">
                        <button class="keyword-add-btn" onclick="addKeywordItemToVibe('${item.id}', this)">
                            ‚ûï Add to Vibe
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        async function addKeywordItemToVibe(itemId, button) {
            try {
                button.textContent = 'Adding...';
                button.disabled = true;
                
                // Add to current vibe profile if it exists, otherwise create new one
                if (currentVibeProfileId) {
                    const response = await fetch(`${API_BASE_URL}/add-to-vibe-profile`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_id: itemId,
                            vibe_profile_id: currentVibeProfileId
                        })
                    });
                    
                    if (response.ok) {
                        button.textContent = 'Added!';
                        button.classList.add('added');
                        
                        // Add to local set and update display
                        vibeProfilePoems.add(itemId);
                        displayVibeSeeds();
                        
                        // Navigate to vibe profile page after a longer delay to ensure DB is updated
                        setTimeout(() => {
                            window.location.href = `/vibe-profile/${currentVibeProfileId}`;
                        }, 3000);
                    } else {
                        throw new Error('Failed to add to vibe profile');
                    }
                } else {
                    // No vibe profile exists yet - add locally and auto-create vibe profile if we have 2+ items
                    vibeProfilePoems.add(itemId);
                    
                    button.textContent = 'Added!';
                    button.classList.add('added');
                    
                    // Update display
                    displayVibeSeeds();
                    
                    // Auto-create vibe profile if we now have 2+ items
                    if (vibeProfilePoems.size >= 2) {
                        await createVibeProfileAutomatically();
                    }
                }
                
            } catch (error) {
                console.error('Error adding item to vibe:', error);
                button.textContent = 'Error';
                button.disabled = false;
                showError('Failed to add item to vibe: ' + error.message);
            }
        }
        
        function clearKeywordSearch() {
            document.getElementById('keyword-search-container').style.display = 'none';
            document.getElementById('keyword-search-input').value = '';
            document.getElementById('keyword-search-results').innerHTML = '';
        }
        
        async function createVibeProfileAutomatically() {
            if (vibeProfilePoems.size < 2) {
                return;
            }
            
            try {
                const allItemIds = Array.from(vibeProfilePoems);
                const response = await fetch(`${API_BASE_URL}/create-vibe-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('vibe-profile-name').value || 'New Vibe',
                        item_ids: allItemIds
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentVibeProfileId = data.vibe_profile_id;
                    
                    // Navigate to vibe profile page after a short delay
                    setTimeout(() => {
                        window.location.href = `/vibe-profile/${data.vibe_profile_id}`;
                    }, 2000);
                } else {
                    throw new Error('Failed to create vibe profile');
                }
            } catch (error) {
                console.error('Error creating vibe profile automatically:', error);
                showError('Failed to create vibe profile: ' + error.message);
            }
        }
        
        // Allow Enter key to trigger search
        document.addEventListener('DOMContentLoaded', () => {
            const keywordInput = document.getElementById('keyword-search-input');
            if (keywordInput) {
                keywordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performKeywordSearch();
                    }
                });
            }
        });
    </script>
</body>
</html>
