<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Profile - Poem Pig</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script>
        console.log('Page loaded at:', new Date().toISOString());
        console.log('JavaScript is working!');
        console.log('Script version:', 'v3.0');
    </script>
</head>
<body>
    <div class="container">
    <nav class="nav">
        <div class="nav-content">
                <a href="/" class="nav-btn">New Vibe</a>
                <a href="/vibes" class="nav-btn">Vibe List</a>
        </div>
    </nav>

        <div class="header">
            <h1>
                <span class="pig-icon">üê∑</span>
                Vibe Match
            </h1>
            <p>Create a vibe and root out matching poems</p>
        </div>

        <button class="back-btn" onclick="goBack()">‚Üê Back to Search</button>

        <div class="main-content">
            <div class="vibe-seeds-container">
                <h2>Vibe Profile</h2>
                <input type="text" id="vibe-profile-name" class="vibe-profile-name" placeholder="Vibe Profile Name" value="New Vibe">
                <div id="vibe-seeds-content">
                    <div class="loading">üê∑ Loading vibe profile...</div>
                </div>
                </div>
                
            <div class="suggested-poems-container">
                <!-- Keyword Search Section -->
                <div class="keyword-search-trigger" style="margin-bottom: 20px;">
                    <div class="keyword-search-form">
                        <input type="text" id="keyword-search-input" class="keyword-search-input" placeholder="Search for keywords in title, author, or text...">
                        <button class="keyword-search-btn" onclick="performKeywordSearch()">üîç Search Keywords</button>
                    </div>
                </div>
                
                <!-- Keyword Search Results Section -->
                <div id="keyword-search-container" class="keyword-search-container" style="display: none;">
                    <div class="keyword-search-header">
                        <h3 class="keyword-search-title">Keyword Search Results</h3>
                        <button class="clear-keyword-search" onclick="clearKeywordSearch()">‚úï Clear</button>
            </div>
                    <div id="keyword-search-results" class="keyword-search-results">
                        <!-- Keyword search results will be displayed here -->
                    </div>
                </div>
                
                <h2 class="suggested-poems-title">Suggested Poems</h2>
                <div id="suggested-poems-content">
                    <div class="loading">Loading suggested poems...</div>
                </div>
                <div class="find-more-container">
                    <button id="find-more-btn" class="find-more-btn" onclick="findMorePoems()">
                        üîç Find 10 More
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/shared.js"></script>
    <script>
        let vibeProfilePoems = new Set();
        let currentVibeProfileId = null;
        let currentVibeProfileName = 'New Vibe';
        let displayedPoemIds = new Set();
        let isExistingVibeProfile = false;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const vibeProfileId = urlParams.get('vibe_profile_id');
        const seedId = urlParams.get('seed_id');

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            if (vibeProfileId) {
                // Load existing vibe profile
                loadExistingVibeProfile(vibeProfileId);
            } else if (seedId) {
                // Create new vibe profile with seed item
                loadSeedItem(seedId);
            } else {
                showError('No vibe profile ID or seed ID provided');
            }
        });

        async function loadExistingVibeProfile(vibeProfileId) {
            try {
                const response = await fetch(`${API_BASE_URL}/get-vibe-profile/${vibeProfileId}`);
                if (!response.ok) {
                    throw new Error('Vibe profile not found');
                }
                
                const vibeProfile = await response.json();
                console.log('Loaded vibe profile:', vibeProfile);
                currentVibeProfileId = vibeProfile.id;
                currentVibeProfileName = vibeProfile.name;
                isExistingVibeProfile = true;
                
                // Set the vibe profile name
                document.getElementById('vibe-profile-name').value = vibeProfile.name;
                console.log('Set input value to:', vibeProfile.name);
                
                // Load the poems from this vibe profile
                const poems = vibeProfile.poems || [];
                poems.forEach(poem => {
                    vibeProfilePoems.add(poem.id);
                });
                
                // Display the vibe seeds
                await displayVibeSeeds();
                
                // Load similar poems
                loadSimilarToVibeProfile();
                
            } catch (error) {
                console.error('Error loading vibe profile:', error);
                showError('Error loading vibe profile: ' + error.message);
            }
        }

        async function loadSeedItem(seedId) {
            try {
                const response = await fetch(`${API_BASE_URL}/item/${seedId}`);
                if (!response.ok) {
                    throw new Error('Item not found');
                }
                
                const item = await response.json();
                vibeProfilePoems.add(item.id);
                currentVibeProfileName = 'New Vibe';
                isExistingVibeProfile = false;
                
                // Display the vibe seeds
                await displayVibeSeeds();
                
                // Load similar poems
                loadSimilarPoems(seedId);
                
            } catch (error) {
                console.error('Error loading seed item:', error);
                showError('Error loading seed item: ' + error.message);
            }
        }

        async function displayVibeSeeds() {
            const nameInput = document.getElementById('vibe-profile-name');
            const content = document.getElementById('vibe-seeds-content');
            
            if (vibeProfilePoems.size === 0) {
                content.innerHTML = '<div class="loading">üê∑ Loading chosen poem...</div>';
                return;
            }
            
            // Update placeholder based on count
            nameInput.placeholder = vibeProfilePoems.size === 1 ? 'Vibe Seed' : 'Vibe Seeds';
            
            // Load all poems in vibe profile
            const poems = [];
            for (const poemId of vibeProfilePoems) {
                try {
                    const response = await fetch(`${API_BASE_URL}/item/${poemId}`);
                    if (response.ok) {
                        const poem = await response.json();
                        poems.push(poem);
                    }
                } catch (error) {
                    console.error(`Error loading poem ${poemId}:`, error);
                }
            }
            
            let html = '';
            poems.forEach(poem => {
                html += `
                    <div class="poem-card chosen-poem-card">
                        <div class="poem-title">${poem.title || 'Untitled'}</div>
                        <div class="poem-author">by ${poem.author || 'Unknown'}</div>
                        <div class="poem-text">${poem.text}</div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }

        async function loadSimilarPoems(seedId) {
            try {
                // Add offset to get different results
                const offset = displayedPoemIds.size;
                
                const response = await fetch(`${API_BASE_URL}/find-similar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: seedId, top_k: 10, offset: offset })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to find similar poems');
                }
                
                const data = await response.json();
                displaySuggestedPoems(data.results || []);
                
            } catch (error) {
                console.error('Error loading similar poems:', error);
                document.getElementById('suggested-poems-content').innerHTML = 
                    `<div class="error">‚ùå Error finding similar items: ${error.message}</div>`;
            }
        }

        async function loadSimilarToVibeProfile() {
            if (!currentVibeProfileId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/find-similar-to-vibe-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        vibe_profile_id: currentVibeProfileId, 
                        top_k: 10,
                        exclude_item_ids: Array.from(displayedPoemIds)
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to find similar poems');
                }
                
                const data = await response.json();
                displaySuggestedPoems(data.results || []);
                
            } catch (error) {
                console.error('Error loading similar poems:', error);
                document.getElementById('suggested-poems-content').innerHTML = 
                    `<div class="error">‚ùå Error finding similar items: ${error.message}</div>`;
            }
        }

        function displaySuggestedPoems(results) {
            const container = document.getElementById('suggested-poems-content');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="no-results">No similar poems found</div>';
                return;
            }

            let html = '';
            results.forEach(result => {
                const poem = result.item;
                if (!poem || displayedPoemIds.has(poem.id)) return;
                
                displayedPoemIds.add(poem.id);
                
                const isInVibeProfile = vibeProfilePoems.has(poem.id);
                
                html += `
                    <div class="poem-card">
                        <div class="poem-title">${poem.title || 'Untitled'}</div>
                        <div class="poem-author">by ${poem.author || 'Unknown'}</div>
                        <div class="poem-text">${poem.text}</div>
                        <div class="poem-buttons">
                            <button class="btn" onclick="addToVibeProfile('${poem.id}', this)" ${isInVibeProfile ? 'disabled' : ''}>
                                ${isInVibeProfile ? '‚úÖ Added' : '‚ûï Add to Vibe'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            if (html) {
                container.insertAdjacentHTML('beforeend', html);
            }
        }

        async function addToVibeProfile(itemId, button) {
            if (vibeProfilePoems.has(itemId)) {
                return; // Already added
            }
            
            try {
                button.textContent = 'Adding...';
                button.disabled = true;
                
                if (isExistingVibeProfile && currentVibeProfileId) {
                    // Add to existing vibe profile
                    const response = await fetch(`${API_BASE_URL}/add-to-vibe-profile`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_id: itemId,
                            vibe_profile_id: currentVibeProfileId
                        })
                    });
                    
                    if (response.ok) {
                        vibeProfilePoems.add(itemId);
                        button.textContent = '‚úÖ Added';
                        displayVibeSeeds();
                        
                        // Refresh suggested poems with updated centroid
                        loadSimilarToVibeProfile();
                    } else {
                        throw new Error('Failed to add to vibe profile');
                    }
                } else {
                    // Add locally and auto-create vibe profile if we have 2+ items
                    vibeProfilePoems.add(itemId);
                    button.textContent = '‚úÖ Added';
                    displayVibeSeeds();
                    
                    // Auto-create vibe profile if we now have 2+ items
                    if (vibeProfilePoems.size >= 2) {
                        await createVibeProfileAutomatically();
                    }
                }
                
            } catch (error) {
                console.error('Error adding item to vibe:', error);
                button.textContent = 'Error';
                button.disabled = false;
                showError('Failed to add item to vibe: ' + error.message);
            }
        }

        async function createVibeProfileAutomatically() {
            if (vibeProfilePoems.size < 2) {
                return;
            }
            
            try {
                const allItemIds = Array.from(vibeProfilePoems);
                const vibeName = document.getElementById('vibe-profile-name').value.trim() || 'New Vibe';
                
                const response = await fetch(`${API_BASE_URL}/create-vibe-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: vibeName,
                        item_ids: allItemIds
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Vibe profile created with data:', data);
                    currentVibeProfileId = data.vibe_profile_id;
                    isExistingVibeProfile = true;
                    
                    // Update URL to reflect the vibe profile ID
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.delete('seed_id');
                    newUrl.searchParams.set('vibe_profile_id', currentVibeProfileId);
                    window.history.replaceState({}, '', newUrl);
                    
                    // Navigate to vibe profile page after a short delay
                    setTimeout(() => {
                        window.location.href = `/vibe-profile.html?vibe_profile_id=${currentVibeProfileId}`;
                    }, 2000);
                } else {
                    throw new Error('Failed to create vibe profile');
                }
            } catch (error) {
                console.error('Error creating vibe profile automatically:', error);
                showError('Failed to create vibe profile: ' + error.message);
            }
        }

        // Keyword search functionality
        async function performKeywordSearch() {
            const input = document.getElementById('keyword-search-input');
            const keywords = input.value.trim();
            
            if (!keywords) {
                alert('Please enter keywords to search for');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/search-keywords`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords })
                });
                
                if (!response.ok) throw new Error('Search failed');
                
                const data = await response.json();
                displayKeywordResults(data.results);
                
                // Show the keyword search container
                document.getElementById('keyword-search-container').style.display = 'block';
                
            } catch (error) {
                console.error('Keyword search error:', error);
                showError('Failed to search keywords: ' + error.message);
            }
        }

        function displayKeywordResults(results) {
            const container = document.getElementById('keyword-search-results');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="no-keyword-results">No items found matching your keywords</div>';
                return;
            }
            
            container.innerHTML = '';
            results.forEach(result => {
                const poem = result.item;
                const card = document.createElement('div');
                card.className = 'keyword-poem-card';
                
                card.innerHTML = `
                    <div class="keyword-poem-title">${poem.title || 'Untitled'}</div>
                    <div class="keyword-poem-author">by ${poem.author || 'Unknown'}</div>
                    <div class="keyword-poem-text">${poem.text}</div>
                    <div class="poem-buttons">
                        <button class="btn" onclick="addToVibeProfile('${poem.id}', this)">
                            ‚ûï Add to Vibe
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function clearKeywordSearch() {
            document.getElementById('keyword-search-container').style.display = 'none';
            document.getElementById('keyword-search-input').value = '';
            document.getElementById('keyword-search-results').innerHTML = '';
        }

        function findMorePoems() {
            if (isExistingVibeProfile && currentVibeProfileId) {
                loadSimilarToVibeProfile();
            } else if (vibeProfilePoems.size > 0) {
                // Use the first item as seed for more similar poems
                const firstItemId = Array.from(vibeProfilePoems)[0];
                loadSimilarPoems(firstItemId);
            } else {
                showError('No poems available to find more similar items');
            }
        }

        function goBack() {
            window.history.back();
        }

        // Allow Enter key to trigger search and save vibe profile name on blur
        document.addEventListener('DOMContentLoaded', () => {
            const keywordInput = document.getElementById('keyword-search-input');
            if (keywordInput) {
                keywordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performKeywordSearch();
                    }
                });
            }
            
            // Save vibe profile name when user finishes editing
            const nameInput = document.getElementById('vibe-profile-name');
            if (nameInput) {
                nameInput.addEventListener('blur', saveVibeProfileName);
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveVibeProfileName();
                    }
                });
            }
        });
        
        async function saveVibeProfileName() {
            if (!isExistingVibeProfile || !currentVibeProfileId) {
                return; // Don't save if it's not an existing vibe profile
            }
            
            const newName = document.getElementById('vibe-profile-name').value.trim();
            if (!newName) {
                return; // Don't save empty names
            }

            try {
                const response = await fetch(`${API_BASE_URL}/update-vibe-profile-name`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        vibe_profile_id: currentVibeProfileId,
                        name: newName
                    })
                });
                
                if (response.ok) {
                    console.log('Vibe profile name updated to:', newName);
                } else {
                    console.error('Failed to update vibe profile name');
                }
            } catch (error) {
                console.error('Error updating vibe profile name:', error);
            }
        }
    </script>
</body>
</html>